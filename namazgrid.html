<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prayer Tracker - Shared</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background:#f7f7f7;
    padding:10px;
  }
  .table-container {
    width: 100%;
    overflow-x: auto;
  }
  table {
    border-collapse: collapse;
    margin:auto;
    min-width: 300px;
  }
  th, td {
    border:2px solid #333;
    padding:6px;
    text-align:center;
    min-width:60px;
  }
  th {
    background:#222;
    color:white;
  }
  td:first-child {
    background:#eee;
    font-weight:bold;
  }
  input[type="checkbox"] {
    width:24px;
    height:24px;
  }
  input[type="text"] {
    width:100%;
    border:none;
    text-align:center;
    font-weight:bold;
    outline:none;
  }
  th input[type="text"] {
    background:#222;
    color:white;
    border-radius:4px;
    padding:2px 4px;
  }
  td:first-child input[type="text"] {
    background:#eee;
    color:black;
    border-radius:4px;
    padding:2px 4px;
  }
  button {
    margin:6px;
    padding:8px 12px;
    font-size:14px;
    cursor: pointer;
  }
  #notes {
    width: 95%;
    min-height: 100px;
    padding:8px;
    font-size:14px;
    border:2px solid #333;
    border-radius:6px;
    display:block;
    margin:auto;
    box-sizing:border-box;
    background:white;
    color:black;
    overflow:hidden;
    resize:none;
  }
  label {
    display:block;
    text-align:center;
    font-weight:bold;
    margin-bottom:4px;
  }

  /* Sync status indicator */
  .sync-bar {
    text-align: center;
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 6px;
    font-size: 14px;
  }
  .sync-bar.connected {
    background: #d4edda;
    color: #155724;
  }
  .sync-bar.disconnected {
    background: #f8d7da;
    color: #721c24;
  }
  .sync-bar.local {
    background: #fff3cd;
    color: #856404;
  }

  /* Setup screen */
  .setup-screen {
    max-width: 400px;
    margin: 50px auto;
    padding: 20px;
    background: white;
    border: 2px solid #333;
    border-radius: 10px;
    text-align: center;
  }
  .setup-screen h2 {
    margin-top: 0;
  }
  .setup-screen input[type="text"] {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 2px solid #333;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
    text-align: left;
  }
  .setup-screen button {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin: 5px 0;
  }
  .setup-screen .divider {
    margin: 15px 0;
    color: #666;
  }

  /* Main app hidden by default */
  #mainApp {
    display: none;
  }

  @media (max-width: 400px) {
    th, td {
      font-size:12px;
      padding:4px;
    }
    input[type="text"] {
      font-size:12px;
    }
    button {
      font-size:12px;
      padding:6px 8px;
    }
  }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setupScreen" class="setup-screen">
  <h2>ðŸ•Œ Prayer Tracker</h2>
  <p>Create or join a shared prayer tracking space</p>
  
  <input type="text" id="setupName" placeholder="Your name (optional)">
  
  <button onclick="createNewSpace()">âœ¨ Create New Space</button>
  
  <div class="divider">â€” or join existing â€”</div>
  
  <input type="text" id="joinCode" placeholder="Enter space code">
  <button onclick="joinSpace()">ðŸ”— Join Space</button>
</div>

<!-- MAIN APP -->
<div id="mainApp">
  <div class="sync-bar" id="syncBar">Connecting...</div>

  <div style="text-align:center;margin-bottom:10px;">
    <button onclick="addColumn()">âž• Add Person</button>
    <button onclick="addRow()">âž• Add Row</button>
    <button onclick="copyShareLink()" id="shareBtn">ðŸ”— Share</button>
  </div>

  <div class="table-container">
    <table id="grid"></table>
  </div>

  <div style="margin-top:20px; width:95%; margin:auto;">
    <label for="notes">Notes</label>
    <textarea id="notes" placeholder="Add your notes here..."></textarea>
  </div>
</div>

<script>
// ============================================
// YOUR FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
  apiKey: "AIzaSyD-IquEthu2KPDlH5F5z5cGOItR_rVJXXo",
  authDomain: "namaz-tracker-f3cdb.firebaseapp.com",
  databaseURL: "https://namaz-tracker-f3cdb-default-rtdb.firebaseio.com",
  projectId: "namaz-tracker-f3cdb",
  storageBucket: "namaz-tracker-f3cdb.firebasestorage.app",
  messagingSenderId: "120676080487",
  appId: "1:120676080487:web:ce00486f0d2fda475cadc2",
  measurementId: "G-Z7XZFCX1CK"
};

// ============================================
// APP STATE
// ============================================

let db = null;
let dataRef = null;
let currentSpace = null;
let data = null;

// Default data structure
function getDefaultData() {
  return {
    cols: ["Zain", "Abbu"],
    rows: ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"],
    checks: {},
    notes: ""
  };
}

// ============================================
// INITIALIZATION
// ============================================

function init() {
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  
  // Check URL for space code
  const urlParams = new URLSearchParams(window.location.search);
  const spaceFromUrl = urlParams.get('space');
  const savedSpace = localStorage.getItem('prayerTrackerSpace');
  
  if (spaceFromUrl) {
    joinSpaceDirectly(spaceFromUrl);
  } else if (savedSpace) {
    joinSpaceDirectly(savedSpace);
  } else {
    // Show setup screen
    document.getElementById('setupScreen').style.display = 'block';
  }
}

// ============================================
// SPACE MANAGEMENT
// ============================================

function generateSpaceCode() {
  const words = ['family', 'home', 'prayers', 'blessed', 'united', 'peace', 'namaz', 'salah'];
  const word = words[Math.floor(Math.random() * words.length)];
  const num = Math.floor(Math.random() * 9999);
  return `${word}-${num}`;
}

function createNewSpace() {
  const name = document.getElementById('setupName').value.trim();
  const spaceCode = generateSpaceCode();
  
  const initialData = getDefaultData();
  if (name) {
    initialData.cols = [name, "Person 2"];
  }
  initialData.created = Date.now();
  
  db.ref('spaces/' + spaceCode).set(initialData).then(() => {
    localStorage.setItem('prayerTrackerSpace', spaceCode);
    joinSpaceDirectly(spaceCode);
  }).catch(err => {
    alert('Error creating space: ' + err.message);
  });
}

function joinSpace() {
  const code = document.getElementById('joinCode').value.trim().toLowerCase();
  if (!code) {
    alert('Please enter a space code');
    return;
  }
  
  db.ref('spaces/' + code).once('value').then(snapshot => {
    if (snapshot.exists()) {
      localStorage.setItem('prayerTrackerSpace', code);
      joinSpaceDirectly(code);
    } else {
      alert('Space not found. Check the code and try again.');
    }
  });
}

function joinSpaceDirectly(spaceCode) {
  currentSpace = spaceCode;
  
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  
  // Update URL without reload
  const newUrl = window.location.pathname + '?space=' + spaceCode;
  window.history.replaceState({}, '', newUrl);
  
  // Set up real-time listener
  dataRef = db.ref('spaces/' + spaceCode);
  
  dataRef.on('value', (snapshot) => {
    const rawData = snapshot.val();
    if (rawData) {
      // Firebase converts arrays to objects sometimes, so ensure arrays
      data = {
        cols: Array.isArray(rawData.cols) ? rawData.cols : Object.values(rawData.cols || {}),
        rows: Array.isArray(rawData.rows) ? rawData.rows : Object.values(rawData.rows || {}),
        checks: rawData.checks || {},
        notes: rawData.notes || ""
      };
      // Ensure we have at least default values
      if (data.cols.length === 0) data.cols = ["Person 1"];
      if (data.rows.length === 0) data.rows = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
    } else {
      data = getDefaultData();
    }
    buildTable();
    updateSyncStatus('connected', `âœ“ Synced â€¢ Code: ${spaceCode}`);
  }, (error) => {
    console.error('Sync error:', error);
    updateSyncStatus('disconnected', 'âœ— Connection lost - ' + error.message);
  });
  
  // Monitor connection state
  db.ref('.info/connected').on('value', (snap) => {
    if (snap.val() === true) {
      updateSyncStatus('connected', `âœ“ Synced â€¢ Code: ${spaceCode}`);
    } else {
      updateSyncStatus('disconnected', 'âš  Reconnecting...');
    }
  });
  
  // Notes auto-save with debounce
  let notesTimeout;
  document.getElementById('notes').addEventListener('input', () => {
    clearTimeout(notesTimeout);
    notesTimeout = setTimeout(() => {
      if (dataRef && data) {
        data.notes = document.getElementById('notes').value;
        dataRef.child('notes').set(data.notes);
      }
    }, 500);
    adjustTextareaHeight();
  });
}

function updateSyncStatus(status, message) {
  const bar = document.getElementById('syncBar');
  bar.className = 'sync-bar ' + status;
  bar.innerHTML = message;
}

// ============================================
// DATA OPERATIONS
// ============================================

function saveData() {
  if (dataRef && data) {
    // Make sure we're saving proper arrays
    const saveObj = {
      cols: data.cols,
      rows: data.rows,
      checks: data.checks || {},
      notes: data.notes || ""
    };
    dataRef.set(saveObj).catch(err => {
      console.error('Save error:', err);
      alert('Error saving: ' + err.message);
    });
  }
}

// ============================================
// TABLE BUILDING
// ============================================

function buildTable() {
  if (!data) return;
  
  const table = document.getElementById("grid");
  table.innerHTML = "";

  // Header row
  let tr = document.createElement("tr");
  let th = document.createElement("th");
  th.innerText = "Prayer";
  tr.appendChild(th);

  data.cols.forEach((c, ci) => {
    let thEl = document.createElement("th");
    let inp = document.createElement("input");
    inp.type = "text";
    inp.value = c || "";
    // Save on blur (when you click away) instead of every keystroke
    inp.onblur = () => {
      if (data.cols[ci] !== inp.value) {
        data.cols[ci] = inp.value;
        saveData();
      }
    };
    // Also save on Enter key
    inp.onkeydown = (e) => {
      if (e.key === 'Enter') {
        inp.blur();
      }
    };
    thEl.appendChild(inp);
    tr.appendChild(thEl);
  });
  table.appendChild(tr);

  // Data rows
  data.rows.forEach((r, ri) => {
    let tr = document.createElement("tr");

    // Row label
    let tdLabel = document.createElement("td");
    let rowInp = document.createElement("input");
    rowInp.type = "text";
    rowInp.value = r || "";
    // Save on blur (when you click away) instead of every keystroke
    rowInp.onblur = () => {
      if (data.rows[ri] !== rowInp.value) {
        data.rows[ri] = rowInp.value;
        saveData();
      }
    };
    // Also save on Enter key
    rowInp.onkeydown = (e) => {
      if (e.key === 'Enter') {
        rowInp.blur();
      }
    };
    tdLabel.appendChild(rowInp);
    tr.appendChild(tdLabel);

    // Checkboxes
    data.cols.forEach((c, ci) => {
      let td = document.createElement("td");
      let cb = document.createElement("input");
      cb.type = "checkbox";
      let key = ri + "-" + ci;
      cb.checked = data.checks[key] || false;
      cb.onchange = () => {
        if (!data.checks) data.checks = {};
        data.checks[key] = cb.checked;
        saveData();
      };
      td.appendChild(cb);
      tr.appendChild(td);
    });

    table.appendChild(tr);
  });

  // Load notes
  const notes = document.getElementById("notes");
  notes.value = data.notes || "";
  adjustTextareaHeight();
}

// ============================================
// ACTIONS
// ============================================

function addColumn() {
  if (!data) {
    alert('Please wait for data to load');
    return;
  }
  if (!Array.isArray(data.cols)) {
    data.cols = [];
  }
  data.cols.push("New Person");
  saveData();
}

function addRow() {
  if (!data) {
    alert('Please wait for data to load');
    return;
  }
  if (!Array.isArray(data.rows)) {
    data.rows = [];
  }
  data.rows.push("New Row");
  saveData();
}

function copyShareLink() {
  if (!currentSpace) {
    alert("No shared space active.");
    return;
  }
  
  const url = window.location.origin + window.location.pathname + '?space=' + currentSpace;
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(url).then(() => {
      alert(
        "Share link copied!\n\n" +
        "Link: " + url + "\n\n" +
        "Space Code: " + currentSpace + "\n\n" +
        "Send this to your dad so he can join!"
      );
    }).catch(() => {
      prompt("Copy this link:", url);
    });
  } else {
    prompt("Copy this link:", url);
  }
}

function adjustTextareaHeight() {
  const notes = document.getElementById("notes");
  notes.style.height = "1px";
  notes.style.height = (notes.scrollHeight) + "px";
}

// ============================================
// START
// ============================================

init();
</script>

</body>
</html>
